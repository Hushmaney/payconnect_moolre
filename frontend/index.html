<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>PAYCONNECT — Checkout</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <style>
    :root {
      --bg: #f6f7fb;
      --card: #ffffff;
      --accent: #0b74ff;
      --muted: #6b7280;
      --success: #065f46;
      --danger: #7f1d1d;
      --radius: 10px;
      --shadow: 0 8px 24px rgba(10,20,40,0.06);
      --maxwidth: 720px;
    }
    * { box-sizing: border-box; }
    body { margin: 0; font-family: Inter, system-ui, -apple-system, "Segoe UI", Roboto, "Helvetica Neue", Arial; background: var(--bg); padding: 28px; display: flex; align-items: center; justify-content: center; min-height: 100vh; }
    .card { width: 100%; max-width: var(--maxwidth); background: var(--card); border-radius: var(--radius); box-shadow: var(--shadow); padding: 22px; position: relative; }
    h1 { margin: 0 0 10px 0; color: var(--accent); font-size: 36px; text-align: center; letter-spacing: 0.2px; }
    form { display: grid; grid-template-columns: 1fr 1fr; gap: 12px 14px; }
    label { display: block; font-weight: 600; font-size: 13px; margin-bottom: 6px; color: #111827; }
    .full { grid-column: 1 / -1; }
    input[type="text"], input[type="email"], input[type="tel"], select { width: 100%; padding: 11px 12px; border-radius: 8px; border: 1px solid #e6e9ef; background: white; font-size: 15px; outline: none; }
    input[readonly] { background: #f3f4f6; color: #111827; }
    .muted { color: var(--muted); font-size: 13px; text-align: center; margin-top: 6px; grid-column: 1 / -1; }
    .actions { grid-column: 1 / -1; display: flex; gap: 12px; margin-top: 6px; }
    button { flex: 1; padding: 12px 14px; border-radius: 9px; border: none; font-weight: 700; font-size: 15px; cursor: pointer; transition: background-color 0.2s, opacity 0.2s; }
    .btn-pay { background: var(--accent); color: white; padding: 14px 14px; font-size: 17px; }
    .btn-pay:hover:not([disabled]) { background: #0963d3; }
    .btn-pay[disabled] { opacity: 0.6; cursor: not-allowed; }
    .btn-clear { background: transparent; border: 1px solid #e6e9ef; color: #111827; }
    .btn-clear:hover { background: #f3f4f6; }
    #message { grid-column: 1 / -1; margin-top: 14px; }
    .msg { padding: 12px; border-radius: 8px; font-weight: 600; text-align: center; }
    .msg.success { background: #ecfdf5; color: var(--success); border: 1px solid #bbf0d0; }
    .msg.error { background: #fff1f2; color: var(--danger); border: 1px solid #f7c2c6; }
    .msg.info { background: #eff6ff; color: #1e3a8a; border: 1px solid #dbeafe; }
    @media (max-width:640px) { form { grid-template-columns: 1fr; gap: 10px; } .actions { flex-direction: column; } .btn-pay { padding: 16px 14px; font-size: 18px; } }
    input:focus, select:focus { box-shadow: 0 4px 12px rgba(11,116,255,0.08); border-color: var(--accent); }
    .small { font-size: 13px; color: var(--muted); }

    #otpSection { grid-column: 1 / -1; border-top: 1px solid #e6e9ef; padding-top: 15px; margin-top: 5px; display: none; }
    #otpSection label { margin-bottom: 8px; }

    body.lock-scroll { overflow: hidden; }
    #fullScreenOverlay { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(255,255,255,0.95); display: none; z-index: 1000; align-items: center; justify-content: center; opacity: 0; transition: opacity 0.3s; }
    #overlayMessageContent { background: #eff6ff; color: #1e3a8a; padding: 30px 40px; border-radius: 12px; box-shadow: 0 10px 25px rgba(0,0,0,0.1); max-width: 80%; text-align: center; font-size: 18px; font-weight: 600; line-height: 1.5; }
    .spinner { border: 4px solid rgba(11,116,255,0.2); border-top: 4px solid #0b74ff; border-radius: 50%; width: 25px; height: 25px; animation: spin 1s linear infinite; margin: 0 auto 15px auto; }
    @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }
  </style>
</head>
<body>
  <main class="card" role="main">
    <h1>PAYCONNECT</h1>

    <form id="checkoutForm" autocomplete="off" novalidate>
      <div class="full">
        <label for="email">Customer Email (optional)</label>
        <input id="email" type="email" inputmode="email" placeholder="you@example.com" />
      </div>

      <div>
        <label for="phone">Customer Phone (Payer's MoMo Number)</label>
        <input id="phone" type="tel" inputmode="numeric" placeholder="0541234567" pattern="[0-9]{10}" maxlength="10" required />
      </div>

      <div>
        <label for="payerNetwork">Payer's MoMo Network</label>
        <select id="payerNetwork" required>
          <option value="">Select MoMo Network</option>
          <option value="MTN">MTN</option>
          <option value="TELECEL">Telecel</option>
          <option value="AIRTELTIGO">AirtelTigo</option>
        </select>
      </div>

      <div>
        <label for="recipient">Data Recipient Number</label>
        <input id="recipient" type="tel" inputmode="numeric" placeholder="0541234567" pattern="[0-9]{10}" maxlength="10" required />
      </div>

      <div>
        <label for="recipientNetwork">Recipient Network</label>
        <select id="recipientNetwork" required>
          <option value="">Select Recipient Network</option>
          <option value="MTN">MTN</option>
          <option value="TELECEL">Telecel</option>
          <option value="AIRTELTIGO">AirtelTigo</option>
        </select>
      </div>

      <div>
        <label for="delivery">Delivery Type</label>
        <select id="delivery" required>
          <option value="Normal">Normal (30 mins - 4 hours)</option>
          <option value="Express">Express (5 - 30 mins)</option>
        </select>
      </div>

      <div class="full">
        <label for="dataplan">Data Plan</label>
        <select id="dataplan" required>
          <option value="">Select a network first</option>
        </select>
      </div>

      <div>
        <label for="amount">Amount (GHS)</label>
        <input id="amount" type="text" readonly placeholder="0.00" />
      </div>
      
      <div id="otpSection" class="full">
        <label for="otpcode">Enter OTP (6-digit code sent via SMS to the payer's number)</label>
        <input id="otpcode" type="text" inputmode="numeric" placeholder="Enter 6-digit OTP" pattern="[0-9]{6}" maxlength="6" />
      </div>
      <div class="muted full small" id="paymentInstruction">
        After clicking **Pay**, we will send an OTP to your phone to confirm the MoMo number.
      </div>

      <div class="actions full">
        <button type="button" class="btn-clear" id="clearBtn">Clear</button>
        <button type="submit" class="btn-pay" id="payBtn">Pay</button>
      </div>

      <div id="message" class="full" aria-live="polite"></div>
    </form>
  </main>

  <div id="fullScreenOverlay">
    <div id="overlayMessageContent"></div>
  </div>

  <script>
    const BACKEND_URL = "https://payconnect-moolre-backend.onrender.com";
    const PAYMENT_ENDPOINT = `${BACKEND_URL}/api/momo-payment`;

    let currentOrderId = null;

    const PLANS = {
      MTN: [["1GB",1,1],["2GB",11,13],["3GB",15.5,17],["4GB",21,23],["5GB",25,27],["6GB",32,35],["8GB",40,42],["10GB",50,52],["15GB",72,74],["20GB",87,89],["25GB",110,112],["30GB",135,137],["40GB",175,177],["50GB",210,212],["100GB",405,407]],
      TELECEL: [["5GB",24,27],["10GB",44,47],["15GB",63,65],["20GB",83,85],["25GB",101,103],["30GB",121,122],["35GB",150,152],["40GB",161,163],["45GB",190,192],["50GB",202,204],["100GB",375,377]],
      AIRTELTIGO: [["1GB",4.5,5],["2GB",8.5,9.5],["3GB",13,14],["4GB",17,18],["5GB",23,24],["6GB",28,29],["7GB",32,33],["8GB",41,42],["10GB",47,48],["12GB",55,56],["15GB",72,73],["20GB",82,83],["25GB",98,99],["30GB",128,129],["40GB",175,176],["50GB",230,231],["100GB",440,441]]
    };

    const emailInput=document.getElementById('email');
    const phoneInput=document.getElementById('phone');
    const recipientInput=document.getElementById('recipient');
    const payerNetworkSel=document.getElementById('payerNetwork');
    const recipientNetworkSel=document.getElementById('recipientNetwork');
    const deliverySel=document.getElementById('delivery');
    const planSel=document.getElementById('dataplan');
    const amountInput=document.getElementById('amount');
    const payBtn=document.getElementById('payBtn');
    const clearBtn=document.getElementById('clearBtn');
    const messageDiv=document.getElementById('message');
    const overlay=document.getElementById("fullScreenOverlay");
    const overlayContent=document.getElementById("overlayMessageContent");
    const otpSection=document.getElementById('otpSection');
    const otpInput=document.getElementById('otpcode');
    const paymentInstruction=document.getElementById('paymentInstruction');

    function formatPrice(p){return Number(p).toFixed(2);}
    function dismissOverlay(){
      overlay.style.opacity='0';
      document.body.classList.remove('lock-scroll');
      setTimeout(()=>{overlay.style.display='none';},300);
    }
    
    function showMessage(text,type='info'){
      messageDiv.innerHTML=''; // Always clear inline message when starting a new message
      if(type==='info'){
        // Use the overlay for 'info' and processing states
        overlayContent.innerHTML=`<div class="spinner"></div>${text}`;
        overlay.style.display='flex';
        // Use a slight timeout to ensure display:flex is applied before setting opacity
        setTimeout(() => {
          overlay.style.opacity='1';
          document.body.classList.add('lock-scroll');
        }, 10);
      }else{
        // Use the inline div for success/error
        dismissOverlay();
        const div=document.createElement('div'); div.textContent=text; div.className=`msg ${type}`;
        messageDiv.appendChild(div);
      }
    }
    function clearMessage(){ dismissOverlay(); messageDiv.innerHTML='';}

    function toggleFormLock(isLocking){
      emailInput.readOnly=isLocking; phoneInput.readOnly=isLocking; recipientInput.readOnly=isLocking;
      payerNetworkSel.disabled=isLocking; recipientNetworkSel.disabled=isLocking;
      deliverySel.disabled=isLocking; planSel.disabled=isLocking; payBtn.disabled=isLocking; clearBtn.disabled=isLocking;
      // Ensure OTP input and button are handled separately during the OTP phase
      if (!isLocking) {
        otpInput.readOnly = false;
        payBtn.disabled = false;
      }
    }
    
    function resetPaymentForm(){ 
      currentOrderId=null; 
      otpInput.value=''; 
      otpSection.style.display='none'; 
      otpInput.removeAttribute('required'); // Remove required attribute when hidden
      payBtn.textContent='Pay'; 
      paymentInstruction.innerHTML='After clicking **Pay**, we will send an OTP to your phone to confirm the MoMo number.'; 
      toggleFormLock(false); 
      clearMessage();
    }

    function autoDetectNetwork(number,targetSelect){
      const trimmed=(number||'').trim(); let detected='';
      if(trimmed.length>=3){ const prefix=trimmed.substring(0,3);
        if(['024','025','053','054','055','059'].some(p=>trimmed.startsWith(p))) detected='MTN';
        else if(['020','050'].some(p=>trimmed.startsWith(p))) detected='TELECEL';
        else if(['026','027','056','057'].some(p=>trimmed.startsWith(p))) detected='AIRTELTIGO';
      }
      targetSelect.value=detected;
      if(targetSelect===recipientNetworkSel) populatePlansForNetwork(detected);
    }

    function populatePlansForNetwork(network){
      planSel.innerHTML=''; amountInput.value='';
      const deliveryName=deliverySel.value;
      if(!network||!PLANS[network]){ planSel.innerHTML='<option value="">Select recipient network first</option>'; planSel.disabled=true; return; }
      planSel.disabled=false;
      const first=document.createElement('option'); first.value=''; first.textContent='Select Data Plan'; planSel.appendChild(first);
      const priceIndex=deliveryName==='Express'?2:1;
      PLANS[network].forEach(([name,normal,express])=>{
        const price=priceIndex===2?express:normal;
        const opt=document.createElement('option');
        // Store the full plan details as a JSON string
        opt.value=JSON.stringify({name:`${network} ${name}`, normal, express});
        opt.textContent=`${name} — GHS ${formatPrice(price)} (${deliveryName})`;
        planSel.appendChild(opt);
      });
      updateAmountFromPlan();
    }
    function updateAmountFromPlan(){ try{ const val=planSel.value; if(!val){ amountInput.value=''; return; } const parsed=JSON.parse(val); const price=deliverySel.value==='Express'?parsed.express:parsed.normal; amountInput.value=formatPrice(price); }catch(err){ amountInput.value=''; } }

    phoneInput.addEventListener('input',()=>{autoDetectNetwork(phoneInput.value,payerNetworkSel); clearMessage();});
    recipientInput.addEventListener('input',()=>{autoDetectNetwork(recipientInput.value,recipientNetworkSel); clearMessage();});
    recipientNetworkSel.addEventListener('change',(e)=>{populatePlansForNetwork(e.target.value); clearMessage();});
    deliverySel.addEventListener('change',()=>{populatePlansForNetwork(recipientNetworkSel.value); clearMessage();});
    planSel.addEventListener('change',()=>{updateAmountFromPlan(); clearMessage();});

    clearBtn.addEventListener('click',()=>{
      document.getElementById('checkoutForm').reset();
      planSel.innerHTML='<option value="">Select a network first</option>';
      planSel.disabled=true;
      amountInput.value='';
      resetPaymentForm();
    });

    document.getElementById('checkoutForm').addEventListener('submit', async(e)=>{
      e.preventDefault();
      const email=emailInput.value.trim();
      const phone=phoneInput.value.trim();
      const recipient=recipientInput.value.trim();
      const recipientNetwork=recipientNetworkSel.value;
      const payerNetwork=payerNetworkSel.value;
      const planVal=planSel.value;
      const otpcode=otpInput.value.trim();

      if(!phone||!recipient||!recipientNetwork||!payerNetwork||!planVal) return showMessage('All required fields must be filled.','error');

      let planData; try{ planData=JSON.parse(planVal);}catch(err){return showMessage('Invalid data plan selected.','error');}
      const deliveryType=deliverySel.value;
      const amount=deliveryType==='Express'?planData.express:planData.normal;
      // This is the formatted string used in the SMS and Airtable
      const mergedDataPlan=`${planData.name} (${deliveryType})`;

      const payload={
        email, 
        phone, 
        recipient, 
        dataPlan:mergedDataPlan, 
        amount:Number(amount), 
        externalref:currentOrderId, 
        otpcode
      };

      let isInitialRequest=!currentOrderId && otpcode==='';

      if(!isInitialRequest && currentOrderId && otpcode.length!==6) return showMessage('Please enter the 6-digit OTP received via SMS.','error');

      // Lock all fields except OTP input during the OTP stage
      toggleFormLock(true);
      
      if(isInitialRequest){ 
        showMessage('Requesting Mobile Money Payment. Please wait for an SMS OTP...','info'); 
      }
      else{ 
        otpInput.readOnly=true; 
        payBtn.textContent='Verifying...'; 
        showMessage('Verifying OTP and sending final MoMo prompt...','info'); 
      }

      try{
        const res=await fetch(PAYMENT_ENDPOINT,{method:'POST', headers:{'Content-Type':'application/json'}, body:JSON.stringify(payload)});
        const data=await res.json().catch(()=>({}));

        if(!res.ok||data.success===false) throw new Error(data.message||data.error||`Server returned ${res.status}`);

        if(data.status==='OTP_REQUIRED'){
          currentOrderId=data.orderId;
          clearMessage();
          // Unlock only the OTP related fields
          toggleFormLock(true); 
          otpSection.style.display='grid';
          otpInput.setAttribute('required', 'required'); // Add required attribute for validation
          otpInput.readOnly=false;
          payBtn.disabled=false;
          payBtn.textContent='Verify & Pay';
          paymentInstruction.innerHTML='Enter the **6-digit OTP** sent to your phone to verify the number and initiate the MoMo prompt.';
          showMessage(data.message || 'OTP has been sent to your phone. Please enter it below to proceed.','info');
          otpInput.focus();
          return;
        }

        if(data.status==='PROMPT_SENT'||data.status==='VERIFIED_AND_PROMPT_SENT'){
          // Successful prompt, now wait for webhook confirmation
          resetPaymentForm();
          showMessage(`Success! A Mobile Money prompt has been sent to ${phone}. Please enter your PIN on your phone to complete the payment of GHS ${amountInput.value}.`,'success');
          // Add optional polling here if needed, but the webhook is the primary source of truth
          return;
        }

        // Catch-all for unexpected success status
        showMessage(data.message || 'Payment process started. Please check your phone for prompts.','info');
        resetPaymentForm();
      }catch(err){
        console.error('Payment error:',err);
        const msg=err.message||'Unknown error occurred.';
        
        if(msg.includes('OTP_FAILED')||msg.includes('TP14')){
          // Handle failed OTP submission
          showMessage('Verification Failed. The OTP was incorrect or expired. Please try again.','error');
          // Re-enable OTP input for another try
          toggleFormLock(true); 
          otpInput.readOnly=false; 
          payBtn.disabled=false; 
          payBtn.textContent='Verify & Pay';
        } else if (msg.includes('Moolre API request failed')) {
          // Handle initial API errors
           showMessage('Payment failed due to an API error. Please check your phone number and network and try again.','error');
           resetPaymentForm();
        } else {
          // Handle other errors
          showMessage('Error: '+msg,'error'); 
          resetPaymentForm();
        }
      }
    });

    (function init(){ populatePlansForNetwork(recipientNetworkSel.value); })();
  </script>
</body>
</html>