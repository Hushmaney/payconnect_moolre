<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>PAYCONNECT — Checkout</title>
  <!-- Load Tailwind CSS classes here for compatibility, though custom CSS is currently used. -->
  <script src="https://cdn.tailwindcss.com"></script>
  <style>
    :root{
      --bg:#f6f7fb;
      --card:#ffffff;
      --accent:#0b74ff;
      --muted:#6b7280;
      --success:#065f46;
      --danger:#7f1d1d;
      --radius:10px;
      --shadow: 0 8px 24px rgba(10,20,40,0.06);
      --maxwidth:720px;
    }
    *{box-sizing:border-box}
    body{
      margin:0;
      font-family:Inter, system-ui, -apple-system, "Segoe UI", Roboto, "Helvetica Neue", Arial;
      background:var(--bg);
      padding:28px;
      display:flex;
      align-items:center;
      justify-content:center;
      min-height:100vh;
    }
    .card{
      width:100%;
      max-width:var(--maxwidth);
      background:var(--card);
      border-radius:var(--radius);
      box-shadow:var(--shadow);
      padding:22px;
      position:relative;
    }
    h1{
      margin:0 0 10px 0;
      color:var(--accent);
      font-size:20px;
      text-align:center;
      letter-spacing:0.2px;
    }
    form{display:grid;grid-template-columns:1fr 1fr;gap:12px 14px;}
    label{
      display:block;
      font-weight:600;
      font-size:13px;
      margin-bottom:6px;
      color:#111827;
    }
    .full{grid-column:1 / -1}
    input[type="text"],
    input[type="email"],
    input[type="tel"],
    select{
      width:100%;
      padding:11px 12px;
      border-radius:8px;
      border:1px solid #e6e9ef;
      background:white;
      font-size:15px;
      outline:none;
    }
    input[readonly]{background:#f3f4f6;color:#111827;}
    .muted{color:var(--muted);font-size:13px;text-align:center;margin-top:6px;grid-column:1 / -1;}
    .actions{grid-column:1 / -1; display:flex; gap:12px; margin-top:6px;}
    button{
      flex:1;
      padding:12px 14px;
      border-radius:9px;
      border:none;
      font-weight:700;
      font-size:15px;
      cursor:pointer;
      transition: background-color 0.2s, opacity 0.2s;
    }
    .btn-pay{background:var(--accent);color:white;}
    .btn-pay:hover:not([disabled]){background:#0963d3;}
    .btn-pay[disabled]{opacity:0.6;cursor:not-allowed}
    .btn-clear{background:transparent;border:1px solid #e6e9ef;color:#111827;}
    .btn-clear:hover{background:#f3f4f6;}
    #message{grid-column:1 / -1; margin-top:14px}
    .msg{
      padding:12px;
      border-radius:8px;
      font-weight:600;
      text-align:center;
    }
    .msg.success{background:#ecfdf5;color:var(--success);border:1px solid #bbf0d0}
    .msg.error{background:#fff1f2;color:var(--danger);border:1px solid #f7c2c6}
    .msg.info{background:#eff6ff;color:#1e3a8a;border:1px solid #dbeafe}
    @media (max-width:640px){
      form{grid-template-columns:1fr;gap:10px}
      .actions{flex-direction:column}
    }
    input:focus,select:focus{box-shadow:0 4px 12px rgba(11,116,255,0.08);border-color:var(--accent)}
    .small{font-size:13px;color:var(--muted)}
  </style>
</head>
<body>
  <main class="card" role="main">
    <h1>PAYCONNECT</h1>

    <form id="checkoutForm" autocomplete="off" novalidate>
      <div class="full">
        <label for="email">Customer Email (optional)</label>
        <input id="email" type="email" inputmode="email" placeholder="you@example.com" />
      </div>

      <div>
        <label for="phone">Customer Phone (Payer's MoMo Number)</label>
        <input id="phone" type="tel" inputmode="numeric" placeholder="0541234567" pattern="[0-9]{10}" maxlength="10" required />
      </div>

      <div>
        <label for="recipient">Data Recipient Number</label>
        <input id="recipient" type="tel" inputmode="numeric" placeholder="0541234567" pattern="[0-9]{10}" maxlength="10" required />
      </div>

      <div>
        <label for="network">Network</label>
        <select id="network" required>
          <option value="">Select Network</option>
          <option value="MTN">MTN</option>
          <option value="TELECEL">Telecel</option>
          <option value="AIRTELTIGO">AirtelTigo</option>
        </select>
      </div>

      <div>
        <label for="delivery">Delivery Type</label>
        <select id="delivery" required>
          <option value="Normal">Normal (30 mins - 4 hours)</option>
          <option value="Express">Express (5 - 30 mins)</option>
        </select>
      </div>

      <div class="full">
        <label for="dataplan">Data Plan</label>
        <select id="dataplan" required>
          <option value="">Select a network first</option>
        </select>
      </div>

      <div>
        <label for="amount">Amount (GHS)</label>
        <input id="amount" type="text" readonly placeholder="0.00" />
      </div>

      <div class="muted full small">
        After clicking <strong>Pay</strong>, you'll be redirected to a secure Moolre payment page.
        Once payment is confirmed, you'll receive an SMS and your order will appear as Pending on our dashboard.
      </div>

      <div class="actions full">
        <button type="button" class="btn-clear" id="clearBtn">Clear</button>
        <button type="submit" class="btn-pay" id="payBtn">Pay</button>
      </div>

      <div id="message" class="full" aria-live="polite"></div>
    </form>
  </main>

  <script>
    // Make sure this URL matches your deployed backend on Render
    const BACKEND_URL = "https://payconnect-moolre-backend.onrender.com";

    const PLANS = {
      MTN: [
        ["1GB", 5.50, 7.00],
        ["2GB", 11.00, 13.00],
        ["3GB", 15.50, 17.00],
        ["4GB", 21.00, 23.00],
        ["5GB", 25.00, 27.00],
        ["6GB", 32.00, 35.00],
        ["8GB", 40.00, 42.00],
        ["10GB", 50.00, 52.00],
        ["15GB", 72.00, 74.00],
        ["20GB", 87.00, 89.00]
      ],
      TELECEL: [
        ["5GB", 24.00, 27.00],
        ["10GB", 44.00, 47.00],
        ["15GB", 63.00, 65.00],
        ["20GB", 83.00, 85.00]
      ],
      AIRTELTIGO: [
        ["1GB", 4.50, 5.00],
        ["2GB", 8.50, 9.50],
        ["3GB", 13.00, 14.00],
        ["4GB", 17.00, 18.00],
        ["5GB", 23.00, 24.00]
      ]
    };

    const networkSel = document.getElementById('network');
    const planSel = document.getElementById('dataplan');
    const amountInput = document.getElementById('amount');
    const payBtn = document.getElementById('payBtn');
    const clearBtn = document.getElementById('clearBtn');
    const messageDiv = document.getElementById('message');
    const deliverySel = document.getElementById('delivery');

    function showMessage(text, type = 'info') {
      messageDiv.innerHTML = '';
      const d = document.createElement('div');
      d.className = 'msg ' + (type === 'success' ? 'success' : (type === 'error' ? 'error' : 'info'));
      d.textContent = text;
      messageDiv.appendChild(d);
    }
    function clearMessage() { messageDiv.innerHTML = ''; }
    function formatPrice(p){ return Number(p).toFixed(2); }

    function populatePlansForNetwork(network){
      planSel.innerHTML = '';
      amountInput.value = '';
      if(!network || !PLANS[network]){
        planSel.innerHTML = '<option value="">Select a network first</option>';
        planSel.disabled = true;
        return;
      }
      planSel.disabled = false;
      let opt = document.createElement('option');
      opt.value = ''; opt.textContent = 'Select Data Plan';
      planSel.appendChild(opt);

      PLANS[network].forEach(plan=>{
        const [name, normal, express] = plan;
        const option = document.createElement('option');
        option.value = JSON.stringify({name:`${network} ${name}`, normal, express});
        option.textContent = `${name} — GHS ${formatPrice(normal)} / GHS ${formatPrice(express)} (Express)`;
        planSel.appendChild(option);
      });
    }

    function updateAmountFromPlan(){
      try{
        const val = planSel.value;
        if(!val){ amountInput.value=''; return; }
        const parsed = JSON.parse(val);
        const price = deliverySel.value === 'Express' ? parsed.express : parsed.normal;
        amountInput.value = formatPrice(price);
      }catch{ amountInput.value=''; }
    }

    networkSel.addEventListener('change', e => { populatePlansForNetwork(e.target.value); clearMessage(); });
    planSel.addEventListener('change', ()=>{ updateAmountFromPlan(); clearMessage(); });
    deliverySel.addEventListener('change', ()=>{ updateAmountFromPlan(); clearMessage(); });

    clearBtn.addEventListener('click', ()=>{
      document.getElementById('checkoutForm').reset();
      // Manually reset dependent fields
      planSel.innerHTML = '<option value="">Select a network first</option>';
      planSel.disabled = true;
      amountInput.value = '';
      clearMessage();
    });

    document.getElementById('checkoutForm').addEventListener('submit', async e => {
      e.preventDefault(); clearMessage();
      const email = document.getElementById('email').value.trim();
      const phone = document.getElementById('phone').value.trim();
      const recipient = document.getElementById('recipient').value.trim();
      const network = networkSel.value;
      const delivery = deliverySel.value;
      const planVal = planSel.value;

      // Basic client-side validation
      if(!phone || !recipient || !network || !planVal) {
        return showMessage('All required fields must be filled.','error');
      }

      const plan = JSON.parse(planVal);
      const amount = delivery === 'Express' ? plan.express : plan.normal;

      // --- CRITICAL UPDATE: Simplified payload matching backend expectations ---
      const payload = { 
        email, 
        phone, 
        recipient, 
        dataPlan: plan.name, // e.g., "MTN 5GB"
        amount: Number(amount) // Ensure amount is sent as a number
      };
      // ------------------------------------------------------------------------

      payBtn.disabled = true; payBtn.textContent = 'Processing...';
      showMessage('Initiating payment...','info');

      try{
        const res = await fetch(BACKEND_URL + '/api/start-checkout', {
          method:'POST',
          headers:{'Content-Type':'application/json'},
          body:JSON.stringify(payload)
        });
        const data = await res.json();
        
        if(!res.ok) {
          // Handle server-side errors (e.g., missing Moolre keys, bad request)
          throw new Error(data.error || 'Failed to start payment due to server error.');
        }

        // The backend returns the payment link directly under 'paymentLink'
        const link = data?.paymentLink; 

        if(link){ 
          showMessage('Redirecting to Moolre...','info'); 
          // Use a small delay before redirecting
          setTimeout(()=>window.location.href=link,500);
        }
        else {
          console.error('Moolre response missing payment link:', data);
          showMessage('Payment initiation succeeded, but no payment link was received. Please check server logs.','error');
        }
      }catch(err){
        console.error('Checkout error:', err); 
        showMessage('Error: '+err.message,'error');
      }finally{
        payBtn.disabled=false; 
        payBtn.textContent='Pay';
      }
    });

    // Initial setup on load
    (function init(){ 
      populatePlansForNetwork(networkSel.value);
    })();
  </script>
</body>
</html>
